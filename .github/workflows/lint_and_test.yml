name: Lint and Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout the code from the repository
    - name: Checkout code
      uses: actions/checkout@v4

    # Step 2: Set up Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    # Step 3: set thresholds for pylint and coverage
    - name: Set up thresholds
      id: thresholds
      run: |
        echo "pylint_threshold=9" >> $GITHUB_OUTPUT
        echo "coverage_threshold=50" >> $GITHUB_OUTPUT
        echo "ALL_CHECKS_PASSED=true" >> $GITHUB_ENV  # Initialize with true

    # Step 4: Install dependencies (including Anybadge)
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install anybadge
        cd app
        pip install -r requirements.txt
        pip install -r test/requirements-dev.txt

  # ---------- PYLINT ---------- #
    # Step 5: Run pylint and calculate the score
    - name: Run pylint
      id: pylint_run
      run: |
        cd app
        pylint_score=$(pylint . --fail-under=${{ steps.thresholds.outputs.pylint_threshold }} --output-format=json:../reports/pylint.json,parseable | tee pylint-report.txt | awk '/Your code has been rated at/ {print $7}' | sed 's/\/10//')
        echo "Pylint score is: $pylint_score /10"
        echo "pylint_score=$pylint_score" >> $GITHUB_OUTPUT
        if echo "$pylint_score < ${{ steps.thresholds.outputs.pylint_threshold }}" | bc -l; then
          exit 1
        fi
      continue-on-error: true  # Do not fail the job yet

    # Step 6: Fail if pylint score is below threshold
    - name: Check pylint score
      id: pylint_check
      if: ${{ steps.pylint_run.outcome == 'failure' }}
      run: |
        echo "Pylint score is below the required threshold. ${{ steps.pylint_run.outputs.pylint_score }}/10 (required >${{ steps.thresholds.outputs.pylint_threshold }}/10)"
        echo "ALL_CHECKS_PASSED=false" >> $GITHUB_ENV  # Mark that one check failed

    # Step 7: Generate PyLint Badge
    - name: Generate PyLint Badge
      id: pylint_generate
      run: |
        if [ "${{ steps.pylint_run.outcome }}" == "failure" ]; then
          echo "FAIL"
          anybadge -l PyLint -v ${{ steps.pylint_run.outputs.pylint_score }} -s /10 -f img/pylint_badge.svg -o -c red
        elif [ "${{ steps.pylint_run.outcome }}" == "success" }} ]; then
          echo "PASS"
          anybadge -l PyLint -v ${{ steps.pylint_run.outputs.pylint_score }} -s /10 -f img/pylint_badge.svg -o pylint
        fi

  # ---------- PYTEST ---------- #
    # Step 7: Run Coverage and generate PyTest report
    - name: Run PyTest with Coverage
      id: pytest_run
      run: |
        coverage run -m pytest --tb=no --json-report --json-report-summary --json-report-indent=4 --json-report-file=../reports/pytest.json
      continue-on-error: true  # Do not fail the job yet
    
    # Step 8: Check pytest result based on exit code
    - name: Check pytest result
      id: pytest_check
      if: ${{ steps.pytest_run.outcome == 'failure' }}
      run: |
        echo "PyTest failed. Setting failure flag."
        echo "ALL_CHECKS_PASSED=false" >> $GITHUB_ENV
  
    # Step 8: Generate PyTest Badge
    - name: Generate PyTest Badge
      id: pytest_generate
      run: |
        if [ "${{ steps.pytest_run.outcome }}" == "failure" }} ]; then
          echo "FAIL"
          anybadge -l PyTest -v FAIL -f img/pytest_badge.svg -o -c red
        elif [ "${{ steps.pytest_run.outcome }}" == "success" ]; then
          echo "PASS"
          anybadge -l PyTest -v PASS -f img/pytest_badge.svg -o -c green
        fi

  # ---------- COVERAGE ---------- #
    # Step 7: Check coverage and generate Coverage report
    - name: Check coverage
      id: coverage_run
      run: |
        coverage report --fail-under=${{ steps.thresholds.outputs.coverage_threshold }}
        coverage json -o reports/coverage.json --pretty-print
        coverage_percentage=$(coverage report | grep 'TOTAL' | awk '{print $4}' | sed 's/%//')
        echo "Coverage percentage is: $coverage_percentage"
        echo "coverage_percentage=$coverage_percentage" >> $GITHUB_OUTPUT
      continue-on-error: true  # Do not fail the job yet

    # Step 8: Check Coverage result based on exit code
    - name: Check Coverage Score
      id: coverage_check
      if: ${{ steps.coverage_run.outcome == 'failure' }}
      run: |
        echo "Coverage is below the required threshold. ${{ steps.coverage_run.outputs.coverage_percentage }}% (required >${{ steps.thresholds.outputs.coverage_threshold }}%)"
        echo "ALL_CHECKS_PASSED=false" >> $GITHUB_ENV

    # Step 9: Generate Coverage Badge
    - name: Generate Coverage Badge
      id: coverage_generate
      run: |
        if [ "${{ steps.coverage_run.outcome }}" == "failure" ]; then
          echo "FAIL"
          anybadge -l Coverage -v ${{ steps.coverage_run.outputs.coverage_percentage }}% -f img/coverage_badge.svg -o -c red
        elif [ "${{ steps.coverage_run.outcome }}" == "success" ]; then
          echo "PASS"
          anybadge -l Coverage -v ${{ steps.coverage_run.outputs.coverage_percentage }} -f img/coverage_badge.svg -o coverage
        fi

  # ---------- UPLOAD ---------- #
    # Step 13: Upload the badges and reports as GitHub artifacts (optional)
    - name: Upload badges an reports
      uses: actions/upload-artifact@v4
      with:
        name: pybadge-and-reports
        path: |
          img/pylint_badge.svg
          img/pytest_badge.svg
          img/coverage_badge.svg
          reports/pylint.json
          reports/pytest.json
          reports/coverage.json

    # (Optional) Step 14: Commit the badges to the repo if you want them automatically updated
    - name: Commit badges
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"
        git add img/pylint_badge.svg img/coverage_badge.svg img/pytest_badge.svg reports/pylint.json reports/coverage.json reports/pytest.json
        git commit -m "Update badges & reports"
        git push
    
    # Step 6: Fail if the tests Failed
    - name: Check Test Result
      if: env.ALL_CHECKS_PASSED == 'true'
      run: |
        exit 1
